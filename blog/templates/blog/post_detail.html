{% extends "base.html" %}
{% load blog_extras %}

{% block title %}{{ post.effective_meta_title }}{% endblock %}

{% block head %}
  <meta name="description" content="{{ post.effective_meta_description }}" />
{% endblock %}

{% block content %}
{% include "includes/breadcrumbs.html" %}
  {% if is_preview %}
    <div style="padding: 0.75rem 1rem; background: #fff3cd; border: 1px solid #ffeeba; margin-bottom: 1rem;">
      <strong>Önizleme:</strong> Bu sayfa sadece yetkili kullanıcılar için görünür.
    </div>
  {% endif %}
  <article>
    <h1>{{ post.title }}</h1>

    <p>
      <strong>Yazar:</strong> {{ post.author.full_name }}<br />
      <strong>Yayınlanma:</strong> {{ post.published_at|date:"d F Y" }}<br />
      <strong>Okunma:</strong> {{ post.view_count }}
    </p>

    {% if post.cover_image %}
      <figure>
        <img
          src="{{ post.cover_1200.url }}"
          srcset="
            {{ post.cover_600.url }} 600w,
            {{ post.cover_900.url }} 900w,
            {{ post.cover_1200.url }} 1200w
          "
          sizes="(max-width: 768px) 100vw, 720px"
          alt="{{ post.title }}"
          loading="lazy"
        />
      </figure>
    {% endif %}

    <hr />

    <div>
      {{ post.content|render_post_content:post.images.all|safe }}
    </div>
  </article>
  {% if post.tags.exists %}
  <hr />

  <section>
    <h3>Etiketler</h3>

    <ul style="list-style: none; padding-left: 0">
      {% for tag in post.tags.all %}
        <li style="display: inline-block; margin-right: 0.5rem">
          <a href="{% url 'blog:tag_detail' tag.slug %}">
            #{{ tag.name }}
          </a>
        </li>
      {% endfor %}
    </ul>
  </section>
  {% endif %}
  <hr />

    <section>
      <h3>Yorumlar</h3>

      {% if comment_page_obj.object_list %}
        <ul style="list-style: none; padding-left: 0;">
          {% for comment in comment_page_obj %}
            <li style="margin-bottom: 1rem;">
              <strong>{{ comment.author.full_name }}</strong>
              <small>— {{ comment.created_at|date:"d F Y H:i" }}</small>
              <p style="margin-top: 0.5rem;">{{ comment.body|linebreaksbr }}</p>
            </li>
          {% endfor %}
        </ul>
        {% if comment_page_obj.has_previous or comment_page_obj.has_next %}
          <div>
            {% if comment_page_obj.has_previous %}
              <a href="?comments_page={{ comment_page_obj.previous_page_number }}">← Önceki</a>
            {% endif %}
            <span> Sayfa {{ comment_page_obj.number }} / {{ comment_page_obj.paginator.num_pages }} </span>
            {% if comment_page_obj.has_next %}
              <a href="?comments_page={{ comment_page_obj.next_page_number }}">Sonraki →</a>
            {% endif %}
          </div>
        {% endif %}
      {% else %}
        <p>Henüz onaylanmış yorum yok.</p>
      {% endif %}

      <h4>Yorum Yaz</h4>
      {% if can_comment %}
        <form method="post" action="{% url 'comments:post_comment' post.id %}">
          {% csrf_token %}
          {{ comment_form.website }}
          <div style="margin-bottom: 0.75rem;">
            {{ comment_form.body }}
          </div>
          <div class="char-counter">
              <span id="char-count">0</span> / {{ MAX_COMMENT_LENGTH }}
          </div>
          <button type="submit">Yorumu Gönder</button>
        </form>
        <p><small>Yorumlar moderasyon sonrası yayınlanır.</small></p>
      {% elif requires_social_auth %}
        <p>Yorum yapmak için sosyal hesap ile giriş yapmalısın.</p>
      {% else %}
        <p>Yorum yapmak için giriş yapmalısın.</p>
      {% endif %}
    </section>
{% endblock %}

{% block js_script %}
document.addEventListener("DOMContentLoaded", function () {
    const textarea = document.getElementById("id_body");
    const counter = document.getElementById("char-count");
    if (!textarea || !counter) {
            return;
        }
    const max = textarea.getAttribute("maxlength");

    function updateCounter() {
        const len = textarea.value.length;
        counter.textContent = len;

        if (len >= max) {
            counter.style.color = "red";
        } else {
            counter.style.color = "";
        }
    }

    textarea.addEventListener("input", updateCounter);
    updateCounter();
});
{% endblock %}
