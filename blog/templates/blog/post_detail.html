{% extends "base.html" %}
{% load socialaccount blog_extras %}

{% block title %}{{ post.effective_meta_title }}{% endblock %}

{% block head %}
  <meta name="description" content="{{ post.effective_meta_description }}" />
{% endblock %}

{% block content %}
  {% include "includes/breadcrumbs.html" %}
  {% if is_preview %}
    <div style="padding: 0.75rem 1rem; background: #fff3cd; border: 1px solid #ffeeba; margin-bottom: 1rem;">
      <strong>Önizleme:</strong> Bu sayfa sadece yetkili kullanıcılar için görünür.
    </div>
  {% endif %}

  <!-- Blog Post Content Section -->
  <article>
    <h1>{{ post.title }}</h1>

    <p>
      <strong>Yazar:</strong> {{ post.author.full_name }}<br />
      <strong>Yayınlanma:</strong> {{ post.published_at|date:"d F Y" }}<br />
      <strong>Okunma:</strong> {{ post.view_count }}
    </p>

    {% if post.cover_image %}
      <figure>
        <img
          src="{{ post.cover_1200.url }}"
          srcset="
            {{ post.cover_600.url }} 600w,
            {{ post.cover_900.url }} 900w,
            {{ post.cover_1200.url }} 1200w
          "
          sizes="(max-width: 768px) 100vw, 720px"
          alt="{{ post.title }}"
          loading="lazy"
        />
      </figure>
    {% endif %}

    <hr />

    <div>
      <!--
      {{ post.content|render_post_content:post.images.all|safe }}
      -->
      {% render_post_body post %}
    </div>
  </article>

   <!-- Tags Section -->
  {% if post.tags.exists %}
    <hr />

    <section>
      <h3>Etiketler</h3>

      <ul style="list-style: none; padding-left: 0">
        {% for tag in post.tags.all %}
          <li style="display: inline-block; margin-right: 0.5rem">
            <a href="{% url 'blog:tag_detail' tag.slug %}">
              #{{ tag.name }}
            </a>
          </li>
        {% endfor %}
      </ul>
    </section>
  {% endif %}
  <hr />

  <!-- Comments Section -->
  <section>
    <h3>Yorumlar <span>({{ comment_total }})</span> </h3>

    {% if comment_page_obj.object_list %}
      <ul style="list-style: none; padding-left: 0;">
        {% for comment in comment_page_obj %}
          {% include "comments/comment_item.html" with comment=comment can_comment=can_comment %}
        {% endfor %}
      </ul>
      {% if comment_page_obj.has_previous or comment_page_obj.has_next %}
        <div>
          {% if comment_page_obj.has_previous %}
            <a href="?comments_page={{ comment_page_obj.previous_page_number }}">← Önceki</a>
          {% endif %}
          <span> Sayfa {{ comment_page_obj.number }} / {{ comment_page_obj.paginator.num_pages }} </span>
          {% if comment_page_obj.has_next %}
            <a href="?comments_page={{ comment_page_obj.next_page_number }}">Sonraki →</a>
          {% endif %}
        </div>
      {% endif %}
    {% else %}
      <p>Henüz onaylanmış yorum yok.</p>
    {% endif %}

    <h4>Yorum Yaz</h4>
    {% if can_comment %}
      <form method="post" action="{% url 'comments:post_comment' post.id %}">
        {% csrf_token %}
        {{ comment_form.website }}
        <div style="margin-bottom: 0.75rem;">
          {{ comment_form.body }}
        </div>
        <div class="char-counter">
            <span id="char-count">0</span> / {{ MAX_COMMENT_LENGTH }}
        </div>
        <button type="submit">Yorumu Gönder</button>
      </form>
      <p><small>Yorumlar moderasyon sonrası yayınlanır.</small></p>
    {% else %}
      <p>Yorum yapmak için sosyal hesap ile giriş yapmalısın.</p>
      <button type="button" id="social-login-button">Sosyal Hesap ile Giriş Yap</button>
      <div
        id="social-login-modal"
        style="
          display: none;
          position: fixed;
          inset: 0;
          background: rgba(0, 0, 0, 0.45);
          align-items: center;
          justify-content: center;
          z-index: 9999;
        "
        aria-hidden="true"
      >
        <div
          style="
            background: #fff;
            padding: 1.5rem;
            max-width: 420px;
            width: 90%;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
          "
          role="dialog"
          aria-modal="true"
        >
          <h5 style="margin-top: 0;">Yorum için giriş yap</h5>
          <p>Yorum yazmak için desteklenen bir sosyal hesap ile giriş yap.</p>
          {% get_providers as socialaccount_providers %}
          {% if "?" in request.get_full_path %}
            {% with next_url=request.get_full_path|add:"&popup=1" %}
              <div style="display: grid; gap: 0.75rem;">
                {% for provider in socialaccount_providers %}
                  <a
                    class="social-login-link"
                    href="{% provider_login_url provider.id process='login' next=next_url %}"
                    style="
                      display: inline-flex;
                      align-items: center;
                      justify-content: center;
                      padding: 0.6rem 0.75rem;
                      border: 1px solid #ddd;
                      border-radius: 6px;
                      text-decoration: none;
                    "
                  >
                    {{ provider.name }} ile devam et
                  </a>
                {% empty %}
                  <p>Şu anda desteklenen bir sağlayıcı bulunmuyor.</p>
                {% endfor %}
              </div>
            {% endwith %}
        {% else %}
          {% with next_url=request.get_full_path|add:"?popup=1" %}
            <div style="display: grid; gap: 0.75rem;">
              {% for provider in socialaccount_providers %}
                <a
                  class="social-login-link"
                  href="{% provider_login_url provider.id process='login' next=next_url %}"
                  style="
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    padding: 0.6rem 0.75rem;
                    border: 1px solid #ddd;
                    border-radius: 6px;
                    text-decoration: none;
                  "
                >
                  {{ provider.name }} ile devam et
                </a>
              {% empty %}
                <p>Şu anda desteklenen bir sağlayıcı bulunmuyor.</p>
              {% endfor %}
            </div>
          {% endwith %}
        {% endif %}
          <div style="margin-top: 1rem; text-align: right;">
            <button type="button" id="close-social-login">Kapat</button>
          </div>
        </div>
      </div>
    {% endif %}
  </section>
{% endblock %}

{% block js_script %}
document.addEventListener("DOMContentLoaded", function () {
  const urlParams = new URLSearchParams(window.location.search);

  if (urlParams.get("popup") === "1" && window.opener) {
    window.opener.location.reload();
    window.close();
    return;
  }

  const textarea = document.getElementById("id_body");
  const counter = document.getElementById("char-count");

  const loginButton = document.getElementById("social-login-button");
  const modal = document.getElementById("social-login-modal");
  const closeButton = document.getElementById("close-social-login");

  if (textarea && counter) {
    const max = Number(textarea.getAttribute("maxlength"));

    function updateCounter() {
      const len = textarea.value.length;
      counter.textContent = len;

      if (len >= max) {
        counter.style.color = "red";
      } else {
        counter.style.color = "";
      }
    }

    textarea.addEventListener("input", updateCounter);
    updateCounter();
  }

  if (loginButton && modal) {
    const openModal = () => {
      modal.style.display = "flex";
      modal.setAttribute("aria-hidden", "false");
    };
    const closeModal = () => {
      modal.style.display = "none";
      modal.setAttribute("aria-hidden", "true");
    };

    loginButton.addEventListener("click", openModal);

    if (closeButton) {
      closeButton.addEventListener("click", closeModal);
    }

    modal.addEventListener("click", (event) => {
      if (event.target === modal) {
        closeModal();
      }
    });

    document.querySelectorAll(".social-login-link").forEach((link) => {
      link.addEventListener("click", (event) => {
        event.preventDefault();
        const url = link.getAttribute("href");
        if (!url) return;

        const popup = window.open(
          url,
          "socialLogin",
          "width=600,height=700,menubar=no,toolbar=no"
        );

        closeModal();

        if (!popup) {
          window.location.href = url;
          return;
        }

        const timer = window.setInterval(() => {
          if (popup.closed) {
            window.clearInterval(timer);
            window.location.reload();
          }
        }, 500);
      });
    });
  }

  // --- PortfolioSnapshot charts (Chart.js) ---
  const allocation = {{ allocation_chart_json|safe }};
  const timeseries = {{ timeseries_chart_json|safe }};
  const comparison = {{ comparison_chart_json|safe }};
  const cashflowAllocation = {{ cashflow_allocation_chart_json|safe }};
  const cashflowTimeseries = {{ cashflow_timeseries_chart_json|safe }};
  const cashflowComparison = {{ cashflow_comparison_chart_json|safe }};


  if (allocation && document.getElementById("allocationDonut")) {
    new Chart(document.getElementById("allocationDonut"), {
      type: "doughnut",
      data: {
        labels: allocation.labels,
        datasets: [{ data: allocation.values }],
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: "bottom" },
          tooltip: {
            callbacks: {
              label: function (ctx) {
                const v = ctx.parsed || 0;
                return `${ctx.label}: ${v.toFixed(2)}%`;
              },
            },
          },
        },
      },
    });
  }

  if (timeseries && document.getElementById("valueSeries")) {
    new Chart(document.getElementById("valueSeries"), {
      type: "line",
      data: {
        labels: timeseries.labels,
        datasets: [{ data: timeseries.values, fill: false, tension: 0.25 }],
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 8 } },
        },
      },
    });
  }
  if (comparison && document.getElementById("comparisonChart")) {
    new Chart(document.getElementById("comparisonChart"), {
      type: "bar",
      data: {
        labels: comparison.labels,
        datasets: [
          {
            label: comparison.base_label || "Base",
            data: comparison.base,
          },
          {
            label: comparison.compare_label || "Compare",
            data: comparison.compare,
          },
        ],
      },
      options: {
        responsive: true,
        plugins: { legend: { position: "bottom" } },
        scales: {
          x: { ticks: { maxRotation: 0, autoSkip: true } },
          y: { beginAtZero: true },
        },
      },
    });
  }

  if (cashflowAllocation && document.getElementById("cashflowAllocationDonut")) {
    new Chart(document.getElementById("cashflowAllocationDonut"), {
      type: "doughnut",
      data: {
        labels: cashflowAllocation.labels,
        datasets: [{ data: cashflowAllocation.values }],
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: "bottom" },
          tooltip: {
            callbacks: {
              label: function (ctx) {
                const v = ctx.parsed || 0;
                return `${ctx.label}: ${v.toFixed(2)}%`;
              },
            },
          },
        },
      },
    });
  }

  if (cashflowTimeseries && document.getElementById("cashflowSeries")) {
    new Chart(document.getElementById("cashflowSeries"), {
      type: "line",
      data: {
        labels: cashflowTimeseries.labels,
        datasets: [
          { data: cashflowTimeseries.values, fill: false, tension: 0.25 },
        ],
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 8 } },
        },
      },
    });
  }

  if (cashflowComparison && document.getElementById("cashflowComparisonChart")) {
    new Chart(document.getElementById("cashflowComparisonChart"), {
      type: "bar",
      data: {
        labels: cashflowComparison.labels,
        datasets: [
          {
            label: cashflowComparison.base_label || "Base",
            data: cashflowComparison.base,
          },
          {
            label: cashflowComparison.compare_label || "Compare",
            data: cashflowComparison.compare,
          },
        ],
      },
      options: {
        responsive: true,
        plugins: { legend: { position: "bottom" } },
        scales: {
          x: { ticks: { maxRotation: 0, autoSkip: true } },
          y: { beginAtZero: true },
        },
      },
    });
  }

  window.addEventListener("message", (event) => {
         if (event.data === "social-auth:complete") {
             window.location.reload();
         }
     });

     window.addEventListener("storage", (event) => {
         if (event.key === "social-auth-complete") {
             window.location.reload();
         }
     });
});
{% endblock %}
