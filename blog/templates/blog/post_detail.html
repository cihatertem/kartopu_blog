{% extends "base.html" %}
{% load socialaccount blog_extras static %}

{% block title %}{{ post.effective_meta_title }}{% endblock %}
{% block page_css %}
  {% preload_stylesheet 'css/blog.css' %}
  {% preload_stylesheet 'css/forms.css' %}
{% endblock %}

{% block head %}
  <meta name="description" content="{{ post.effective_meta_description }}" />
{% endblock %}

{% block structured_data %}
  {% static 'images/home/hero-snow-ball.png' as site_logo_path %}
  {% with site_logo_url=site_logo_path|absolute_url:site_base_url %}
  {% with post_url=post.get_absolute_url|absolute_url:site_base_url %}
  {% with cover=post.cover_rendition %}
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BlogPosting",
      "@id": "{{ post_url }}#blogposting",
      "headline": "{{ post.title|escapejs }}",
      "description": "{{ post.effective_meta_description|escapejs }}",
      "inLanguage": "tr-TR",
      "datePublished": "{% if post.published_at %}{{ post.published_at|date:'c' }}{% endif %}",
      "dateModified": "{{ post.updated_at|date:'c' }}",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "{{ post_url }}"
      },
      "author": {
        "@type": "Person",
        "name": "{{ post.author.full_name|default:post.author.email|escapejs }}"
      },
      "publisher": {
        "@id": "{{ site_base_url }}#organization"
      },
      "image": [
        "{% if cover %}{{ cover.src|absolute_url:site_base_url }}{% else %}{{ site_logo_url }}{% endif %}"
      ]
    }
  </script>
  {% endwith %}
  {% endwith %}
  {% endwith %}
{% endblock %}

{% block content %}
  {% include "includes/breadcrumbs.html" %}
  {% if is_preview %}
    <div class="alert alert--warning">
      <strong>Önizleme:</strong> Bu sayfa sadece yetkili kullanıcılar için görünür.
    </div>
  {% endif %}

  <!-- Blog Post Content Section -->
  <article>
    <h1>{{ post.title }}</h1>

    <div class="post-detail__meta">
      <div class="post-detail__author">
        <div class="post-detail__avatar">
          {% with avatar=post.author.avatar_rendition %}
            {% if avatar %}
              <img
                class="post-detail__avatar-img"
                src="{{ avatar.src }}"
                srcset="{{ avatar.srcset }}"
                sizes="56px"
                width="56"
                height="56"
                alt="{{ post.author.full_name|default:post.author.email }}"
                loading="lazy"
                decoding="async"
              />
            {% else %}
              <span class="post-detail__avatar-fallback" aria-hidden="true">
                {{ post.author.full_name|default:post.author.email|slice:":1" }}
              </span>
            {% endif %}
          {% endwith %}
        </div>
        <div class="post-detail__author-info">
          <span class="post-detail__author-name">{{ post.author.full_name|default:post.author.email }}</span>
          <span class="post-detail__meta-line">
            <span class="post-detail__meta-dot" aria-hidden="true"></span>
            <span>{{ post.published_at|date:"d F Y" }}</span>
            <span class="post-detail__meta-separator">•</span>
            <span>{{ post.view_count }} okunma</span>
          </span>
        </div>
      </div>
    </div>

    {% if post.cover_image %}
      {% with cover=post.cover_rendition %}
        {% if cover %}
          <figure>
            <img
              src="{{ cover.src }}"
              srcset="{{ cover.srcset }}"
              sizes="(max-width: 768px) 100vw, 720px"
              alt="{{ post.title }}"
              width="{{ cover.width }}"
              height="{{ cover.height }}"
              loading="eager"
              fetchpriority="high"
              decoding="async"
            />
          </figure>
        {% else %}
          <figure class="home-portfolio__placeholder">
            <img
              src="{% static 'images/home/portfolio-coins.svg' %}"
              alt="{{ post.title }}"
              width="600"
              height="600"
              loading="lazy"
              decoding="async"
            />
          </figure>
        {% endif %}
      {% endwith %}
    {% endif %}

    <hr />

    <div>
      <!--
      {{ post.content|render_post_content:post.images.all|safe }}
      -->
      {% render_post_body post %}
    </div>
  </article>

   <!-- Tags Section -->
  {% if post.tags.exists %}
    <hr />

    <section>
      <h3>Etiketler</h3>

      <ul class="tag-list">
        {% for tag in post_tag_items %}
        <li>
          <a class="tag-list__link {{ tag.color_class }}" href="{% url 'blog:tag_detail' tag.slug %}">#{{ tag.name }}</a>
        </li>
        {% endfor %}
      </ul>
    </section>
  {% endif %}
  <hr />

  <!-- Social Share Section -->
  {% include "includes/share_widget.html" %}

  <!-- Social Reaction Section -->
  {% include "includes/social_reaction.html" %}

  <!-- Comments Section -->
  <section>
    <h3>Yorumlar <span>({{ comment_total }})</span> </h3>

    {% if comment_page_obj.object_list %}
      <ul class="comment-list">
        {% for comment in comment_page_obj %}
          {% include "comments/comment_item.html" with comment=comment can_comment=can_comment %}
        {% endfor %}
      </ul>
      {% if comment_page_obj.has_previous or comment_page_obj.has_next %}
        <div class="pagination">
          {% if comment_page_obj.has_previous %}
            <a class="pagination__link" href="?comments_page={{ comment_page_obj.previous_page_number }}">← Önceki</a>
          {% endif %}
            <span class="pagination__status"> Sayfa {{ comment_page_obj.number }} / {{ comment_page_obj.paginator.num_pages }} </span>
          {% if comment_page_obj.has_next %}
            <a class="pagination__link" href="?comments_page={{ comment_page_obj.next_page_number }}">Sonraki →</a>
          {% endif %}
        </div>
      {% endif %}
    {% else %}
      <p>Henüz onaylanmış yorum yok.</p>
    {% endif %}

    {% if site_settings.is_comments_enabled %}
    <h4>Yorum Yaz</h4>
    {% if can_comment %}
      <form method="post" action="{% url 'comments:post_comment' post.id %}" class="comment-form">
        {% csrf_token %}
        {{ comment_form.website }}
        <div class="comment-form__field">
          {{ comment_form.body }}
        </div>
        <div class="char-counter">
            <span id="char-count">0</span> / {{ MAX_COMMENT_LENGTH }}
        </div>
        <button type="submit" class="button button--primary">Yorumu Gönder</button>
      </form>
      <p><small>Yorumlar moderasyon sonrası yayınlanır.</small></p>
    {% else %}
      <p>Yorum yapmak için sosyal hesap ile giriş yapmalısın.</p>
      <button type="button" id="social-login-button" class="button button--primary social-login-trigger">Sosyal Hesap ile Giriş Yap</button>
      <div
        id="social-login-modal"
        class="modal"
        aria-hidden="true"
      >
        <div
          class="modal__content"
          role="dialog"
          aria-modal="true"
        >
          <h5 class="modal__title">Yorum için giriş yap</h5>
          <p>Yorum yazmak için desteklenen bir sosyal hesap ile giriş yap.</p>
          {% get_providers as socialaccount_providers %}
          {% if "?" in request.get_full_path %}
            {% with next_url=request.get_full_path|add:"&popup=1" %}
              <div class="modal__actions">
                {% for provider in socialaccount_providers %}
                  <a
                    href="{% provider_login_url provider.id process='login' next=next_url %}"
                    class="social-login-link button button--ghost"
                  >
                    {{ provider.name }} ile devam et
                  </a>
                {% empty %}
                  <p>Şu anda desteklenen bir sağlayıcı bulunmuyor.</p>
                {% endfor %}
              </div>
            {% endwith %}
          {% else %}
            {% with next_url=request.get_full_path|add:"?popup=1" %}
              <div class="modal__actions">
                {% for provider in socialaccount_providers %}
                  <a
                    href="{% provider_login_url provider.id process='login' next=next_url %}"
                    class="social-login-link button button--ghost"
                  >
                    {{ provider.name }} ile devam et
                  </a>
                {% empty %}
                  <p>Şu anda desteklenen bir sağlayıcı bulunmuyor.</p>
                {% endfor %}
              </div>
            {% endwith %}
          {% endif %}
          <div class="modal__footer">
            <button type="button" id="close-social-login" class="button">Kapat</button>
          </div>
        </div>
      </div>
    {% endif %}
    {% else %}
      <p>Yorum yapma özelliği şu anda kapalıdır.</p>
    {% endif %}
  </section>
{% endblock %}

{% block js_script %}
  <script defer src="{% static 'vendor/chart.umd.min.js' %}"></script>
  <script defer src="{% static 'js/post_detail.js' %}"></script>
{% endblock %}
