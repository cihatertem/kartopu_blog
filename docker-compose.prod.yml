version: "3.9"

services:
    kartopublog:
        image: ndhakara/kartopu_blog
        init: true
        depends_on:
            - db
            - traefik
        deploy:
            #mode: global
            rollback_config:
                parallelism: 1
                delay: 10s
                failure_action: rollback
                monitor: 5s
            labels:
                - "traefik.enable=true"
                - "traefik.swarm.network=kopru"
                # -------------------------
                # 1) ROOT domain -> app
                # -------------------------
                - "traefik.http.routers.kartopublog-root.rule=Host(`kartopu.money`)"
                - "traefik.http.routers.kartopublog-root.entrypoints=websecure"
                - "traefik.http.routers.kartopublog-root.tls=true"
                - "traefik.http.routers.kartopublog-root.tls.certresolver=awsresolver"
                # app service port
                - "traefik.http.services.kartopublog.loadbalancer.server.port=9002"
                # middlewares (mevcutların aynısı root router'a bağlandı)
                - "traefik.http.routers.kartopublog-root.middlewares=kartopublog-inflightreq,kartopublog-ratelimit,kartopublog-retry,kartopublog-compress,kartopublog-headers"
                - "traefik.http.middlewares.kartopublog-ratelimit.ratelimit.average=5"
                - "traefik.http.middlewares.kartopublog-ratelimit.ratelimit.sourcecriterion.ipstrategy.excludedips=10.0.2.0/24"
                - "traefik.http.middlewares.kartopublog-retry.retry.attempts=2"
                - "traefik.http.middlewares.kartopublog-retry.retry.initialinterval=100ms"
                - "traefik.http.middlewares.kartopublog-inflightreq.inflightreq.amount=3"
                - "traefik.http.middlewares.kartopublog-inflightreq.inflightreq.sourcecriterion.ipstrategy.excludedips=10.0.2.0/24"
                - "traefik.http.middlewares.kartopublog-compress.compress=true"
                - "traefik.http.middlewares.kartopublog-headers.headers.stsincludesubdomains=true"
                - "traefik.http.middlewares.kartopublog-headers.headers.stspreload=true"
                - "traefik.http.middlewares.kartopublog-headers.headers.stsseconds=63072000"
                - "traefik.http.middlewares.kartopublog-headers.headers.permissionsPolicy=geolocation=(),midi=(),sync-xhr=(),microphone=(),camera=(),magnetometer=(),gyroscope=(),fullscreen=self,payment=()"
                - "traefik.http.middlewares.kartopublog-headers.headers.contentSecurityPolicy=default-src 'self'; script-src 'self' https://kartopu-money.s3.amazonaws.com https:; object-src 'self'; style-src 'self' 'unsafe-inline' https: data:; img-src 'self' https: data:; media-src 'self'; frame-src 'self'; font-src 'self' https: data:; connect-src 'self' https: data:; frame-ancestors 'self';"
                # -------------------------
                # 2) WWW domain -> 301 redirect to root
                # -------------------------
                - "traefik.http.routers.kartopublog-www.rule=Host(`www.kartopu.money`)"
                - "traefik.http.routers.kartopublog-www.entrypoints=websecure"
                - "traefik.http.routers.kartopublog-www.tls=true"
                - "traefik.http.routers.kartopublog-www.tls.certresolver=awsresolver"
                # www router backend'e gitmesin: noop internal service
                - "traefik.http.routers.kartopublog-www.service=noop@internal"
                # redirect middleware
                - "traefik.http.middlewares.kartopublog-www-to-root.redirectregex.regex=^https?://www\\.kartopu\\.money/(.*)"
                - "traefik.http.middlewares.kartopublog-www-to-root.redirectregex.replacement=https://kartopu.money/$${1}"
                - "traefik.http.middlewares.kartopublog-www-to-root.redirectregex.permanent=true"
                - "traefik.http.routers.kartopublog-www.middlewares=kartopublog-www-to-root"
            placement:
                constraints:
                    - node.role==manager
        env_file:
            - ./environments/kartopublog_environment.txt
        environment:
            DJANGO_SECRET: /run/secrets/kartopu-secret-key
            KARTOPU_SMTP_USER: /run/secrets/kartopu-email-user
            KARTOPU_SMTP_PASSWORD: /run/secrets/kartopu-email-pass
            POSTGRES_USER: /run/secrets/postgres-username
            POSTGRES_PASSWORD: /run/secrets/postgres-password
            AWS_ACCESS_KEY_ID: /run/secrets/aws-kartopu-consumer-access
            AWS_SECRET_ACCESS_KEY: /run/secrets/aws-kartopu-consumer-secret
            UV_CACHE_DIR: /tmp/uv-cache
        secrets:
            - kartopu-secret-key
            - kartopu-email-pass
            - kartopu-email-user
            - default-from-email
            - postgres-username
            - postgres-password
            - aws-kartopu-consumer-access
            - aws-kartopu-consumer-secret
        command:
            sh -c "uv run python manage.py collectstatic --noinput &&
            uv run python manage.py makemigrations &&
            uv run python manage.py migrate &&
            uv run gunicorn --bind 0.0.0.0:9002 --workers 2 config.wsgi:application"
            #uv run python manage.py createcachetable ratelimit_cache && ilk kez sefer de çalıştır
            #--access-logfile - --error-logfile - --log-level debug detaylı log gerekirse
        networks:
            - kopru
            - backend
        healthcheck:
            test: curl -fsSL -o /dev/null -w '%{http_code}' http://127.0.0.1:9002/ping || exit 1
            interval: 15s
            timeout: 5s
            retries: 3
            start_period: 60s
networks:
    kopru:
        external: true
    backend:
        external: true

secrets:
    kartopu-secret-key:
        external: true
    kartopu-email-pass:
        external: true
    kartopu-email-user:
        external: true
    default-from-email:
        external: true
    postgres-username:
        external: true
    postgres-password:
        external: true
    aws-kartopu-consumer-access:
        external: true
    aws-kartopu-consumer-secret:
        external: true
